<!--
  ~ Copyright 2018, TeamDev Ltd. All rights reserved.
  ~
  ~ Redistribution and use in source and/or binary forms, with or without
  ~ modification, must retain the above copyright notice and the following
  ~ disclaimer.
  ~
  ~ THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
  ~ "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
  ~ LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
  ~ A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
  ~ OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
  ~ SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
  ~ LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
  ~ DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
  ~ THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
  ~ (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
  ~ OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  -->

<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">

<dom-module id="exlibris-book-details-redirect-link">
    <template>
        <style>
            :host {
                @apply --paper-font-body1;
                display: flex;
                margin: 5px 0 5px 0;

            }

            #code-type {
                padding-right: 5px;
            }

            #title {
                display: flex;
                color: var(--exlibris-app-primary-color);
                font-weight: 700;
            }

        </style>

        <a id="title" target="_blank" href="[[redirectValues.href]]">
            <div id="code-type" hidden="[[!redirectValues.codeType.length]]">
                [[redirectValues.codeType]]
            </div>
            [[redirectValues.title]]
        </a>
        </div>
    </template>

    <script>
        const BOOK_CODE_MATCHERS = {
            ISBN_10: /^\d{10}$/g,
            ISBN_13: /^\d{13}$/g,
            ASIN: /^[\d, A-Z]{10}$/g
        };

        const EXTERNAL_SEARCH_LINKS = {
            AMAZON: 'https://www.amazon.com/%s/dp/%s/',
            PLAY_BOOKS: 'https://play.google.com/store/search?q=%s&c=books'
        };

        String.prototype.format = function () {
            return [...arguments].reduce((p, c) => p.replace(/%s/, c), this);
        };

        /**
         * The book external link component.
         *
         * Generates the link to the one of global book services and
         * opens it in the new tab. The external service choice depends
         * on the book code format.
         *
         * @customElement
         * @polymer
         */
        class ExlibrisBookDetailsRedirectLink extends Polymer.Element {
            static get is() {
                return 'exlibris-book-details-redirect-link';
            }

            static get properties() {
                return {
                    /**
                     * The book unique code.
                     * Can be presented in the form of ISBN-10, ISBN-13 or ASIN.
                     */
                    bookCode: String,

                    /**
                     * The book title.
                     */
                    bookTitle: String,

                    /**
                     * The book external link reference, title and the code type.
                     *
                     * @property {string} codeType the detected book code type.
                     * @property {string} title  the reference title.
                     * @property {string} href  the link to open in the new tab.
                     */
                    redirectValues: {
                        type: Object,
                        computed: "_calculateReference(bookCode, bookTitle)"
                    }
                };
            }

            /**
             * Checks for the passed book code format.
             *
             * If the `bookCode` matches the `ISBN-10` or `ASIN` pattern, generates
             * the Amazon book link.
             * If the `bookCode` matches the `ISBN-13` pattern, generates the Google Play Books
             * search by the `ISBN-13` link.
             * If the `bookCode` does not match any patterns, generates the Google Play Books
             * search by the `bookTitle`.
             */
            _calculateReference(bookCode, bookTitle) {
                if (bookCode && bookTitle) {
                    if (bookCode.match(BOOK_CODE_MATCHERS.ISBN_10)) {
                        return {
                            codeType: 'ISBN:',
                            title: bookCode,
                            href: EXTERNAL_SEARCH_LINKS.AMAZON.format(bookTitle, bookCode)
                        }
                    }

                    if (bookCode.match(BOOK_CODE_MATCHERS.ISBN_13)) {
                        return {
                            codeType: 'ISBN:',
                            title: bookCode,
                            href: EXTERNAL_SEARCH_LINKS.PLAY_BOOKS.format(bookCode)
                        }
                    }
                    if (bookCode.match(BOOK_CODE_MATCHERS.ASIN)) {
                        return {
                            codeType: 'ASIN:',
                            title: bookCode,
                            href: EXTERNAL_SEARCH_LINKS.AMAZON.format(bookTitle, bookCode)
                        }
                    }
                }
                if (bookTitle) {
                    return {
                        codeType: '',
                        title: 'Search on Google play',
                        href: EXTERNAL_SEARCH_LINKS.PLAY_BOOKS.format(bookTitle)
                    }
                }
            }
        }

        window.customElements.define(ExlibrisBookDetailsRedirectLink.is, ExlibrisBookDetailsRedirectLink);
    </script>
</dom-module>
